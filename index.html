<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>1505班</title>
  <link rel="stylesheet" href="./css/main.css">
</head>

<body>
  <div id="js-header" class="header">
    <a class="h arrow-return" href="javascript:;"><img src="./image/1_03.jpg"/></a>
    <span class="header-title">1505班(9)</span>
    <a class="h group-header" href="javascript:;"><img src="./image/1_06.jpg"/></a>
  </div>
  <div id="app" class="container js-container">
    <template v-for="item in renderData" :key="item.id">
      <div class="flow-left clearfix" v-if="item.type == 'leftText'">
        <div class="flow-time">
          <div class="date-time">{{item.dateTime}}</div>
        </div>
        <div class="left-header">
          <div class="img-box">
            <img :src="item.headImage" alt="" class="pic">
          </div>
        </div>
        <div class="left-main">
          <div class="left-txt">
            <span class="left-arrow"></span>{{ item.content }}
          </div>
        </div>
      </div>
      <div class="flow-right rightText clearfix" v-if="item.type == 'rightText'">
        <div class="flow-time">
          <div class="date-time">{{item.dateTime}}</div>
        </div>
        <div class="right-header">
          <div class="img-box">
            <img :src="item.headImage" alt="" class="pic">
          </div>
        </div>
        <div class="right-main clearfix">
          <div class="right-txt">
            <span class="right-arrow"></span> {{item.content}}
          </div>
        </div>
      </div>
      <div class="flow-left leftAudio clearfix" v-if="item.type == 'leftSound'">
        <div class="flow-time">
          <div class="date-time">{{item.dateTime}}</div>
        </div>
        <div class="left-header">
          <div class="img-box">
            <img :src="item.headImage" alt="" class="pic">
          </div>
        </div>
        <div class="left-main">
          <div class="left-audio js-audio">
            <i class="radio-step js-radio-step icon-radio-step3"></i>
            <audio :src="item.sound.url" class="js-audiosrc"></audio>
            <span class="delay-second">{{item.sound.duration}}</span>
          </div>
        </div>
      </div>
      <div class="flow-right rightAudio clearfix" v-if="item.type == 'rightSound'">
        <div class="flow-time">
          <div class="date-time">{{item.dateTime}}</div>
        </div>
        <div class="right-header">
          <div class="img-box">
            <img :src="item.headImage" alt="" class="pic">
          </div>
        </div>
        <div class="right-main clearfix">
          <div class="right-audio js-audio">
            <i class="radio-step js-radio-step icon-radio-step3"></i>
            <audio :src="item.sound.url" class="js-audiosrc"></audio>
            <span class="delay-second">{{item.sound.duration}}</span>
          </div>
        </div>
      </div>
      <div class="flow-left leftImg clearfix" v-if="item.type == 'leftImage'">
        <div class="flow-time">
          <div class="date-time">{{item.dateTime}}</div>
        </div>
        <div class="left-header">
          <div class="img-box">
            <img :src="item.headImage" alt="" class="pic">
          </div>
        </div>
        <div class="left-main">
          <div class="left-img">
            <span class="left-arrow"></span>
            <img :src="item.imageArray.turl" alt="">
          </div>
        </div>
      </div>
      <div class="flow-right rightImg clearfix" v-if="item.type == 'rightImage'">
        <div class="flow-time">
          <div class="date-time">{{item.dateTime}}</div>
        </div>
        <div class="right-header">
          <div class="img-box">
            <img :src="item.headImage" alt="" class="pic">
          </div>
        </div>
        <div class="right-main clearfix">
          <div class="right-img">
            <span class="right-arrow"></span>
            <img :src="item.imageArray.turl" alt="" class="pic">
          </div>
        </div>
    </div>
    </template>
  </div>
  <div id="js-footer" class="footer">
    <a href="javascript:;" class="check-key"><img src="./image/1_11.jpg" alt=""></a>
    <div class="check-main">
      <input type="text" name="" class="input-show">
      <span class="txt-show">按住说话</span>
    </div>
    <a href="javascript:;" class="img-smile"><img src="./image/1_13.jpg" alt=""></a>
    <a href="javascript:;" class="img-plus"><img src="./image/1_15.jpg" alt=""></a>
  </div>


  <script type="text/javascript" src="./js/jquery-2.1.1.min.js"></script>
  <script type="text/javascript" src="./js/vue.min.js"></script>

  <script type="text/javascript">
    var vm = new Vue({
      el: "#app",
      data: {
        renderData: []
      },
      created() {

      },
      mounted: function() {
        var that = this;
        this.$nextTick(function() {
          that.initUI();
          that.dataRender();
        })
      },
      methods: {
        initUI: function() {
          this.$container = $(".js-container");
          this.$audioParents = $(".js-audio");
          this.$audioLoops = this.$audioParents.find(".js-radio-step");
          this.$audios = this.$audioParents.find(".js-audiosrc");
          this.loopTimeId = null;
        },
        audioPlay: function(el) {
          el.play();
        },
        audioPause: function(el) {
          el.pause();
          el.currentTime = 0;
        },
        audioLoopPlay: function($el, audioEl) {
          var that = this;
          (function _loop() {
            that.loopTimeId = setTimeout(function() {
              if ($el.hasClass("icon-radio-step1")) {
                $el.addClass("icon-radio-step2").removeClass("icon-radio-step1 icon-radio-step3")
              } else if ($el.hasClass("icon-radio-step2")) {
                $el.addClass("icon-radio-step3").removeClass("icon-radio-step1 icon-radio-step2")
              } else if ($el.hasClass("icon-radio-step3")) {
                $el.addClass("icon-radio-step1").removeClass("icon-radio-step2 icon-radio-step3")
              }
              //如果语音播放结束就停止动画
              if (audioEl.ended) {
                $el.addClass("icon-radio-step3").removeClass("icon-radio-step2 icon-radio-step1");
                return;
              }
              _loop();
            }, 500)
          })()

        },
        audioLoopStop: function($el) {
          $el.addClass("icon-radio-step3").removeClass("icon-radio-step2 icon-radio-step1");
          clearTimeout(this.loopTimeId);
        },
        eventInit: function() {
          var that = this;
          $(function() {
            that.$container.on("click", ".js-audio", function(e) {
              var $that = $(this);
              var currentAudio = $that.find(".js-audiosrc")[0];
              var $currentLoop = $that.find(".js-radio-step");
              //先暂停所有播放的声音与动画
              $(".js-audio").not($that).each(function() {
                that.audioPause($(this).find('.js-audiosrc')[0]);
                that.audioLoopStop($(this).find('.js-radio-step'));
                $(this).attr("data-play-flag", false);
              })

              //如果继续点击当前语音就暂停播放
              if ($that.attr("data-play-flag") === 'true') {
                that.audioPause(currentAudio);
                that.audioLoopStop($currentLoop);
                $that.attr("data-play-flag", false);
              } else {
                //让当前的播放并且声音动画开始
                that.audioPlay(currentAudio);
                that.audioLoopPlay($currentLoop, currentAudio);
                $that.attr("data-play-flag", true);
              }

            })
          })



        },
        dataRender: function() {
          var that = this;
          $(function() {
            $.ajax({
              type: 'GET',
              url: 'http://localhost:3003/communication',
              dataType: 'json',
              success: function(data) {
                that.renderData = data.posts;
                // that.renderData.end == '0' ? that.renderTemplate(that.renderData.posts) : "";
                // that.renderData.end == '0' ? that.templateEngineer(that.renderData.posts) : "";
                that.initUI();
                that.eventInit();
              }
            })
          })
        },
      }
    })
  </script>

  <!-- <script type="text/javascript" src="./js/page.js"></script> -->
</body>

</html>
